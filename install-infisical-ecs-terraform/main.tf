// Add Infisical root credentials in parameter store under path /infisical-core 
data "aws_ssm_parameters_by_path" "infisical_server_secrets" {
  path = "/infisical-core"
}


module "ecs_cluster" {
  source = "terraform-aws-modules/ecs/aws//modules/cluster"

  cluster_name              = "infisical"
  create_task_exec_iam_role = true
  create_task_exec_policy   = true

  cluster_configuration = {
    execute_command_configuration = {
      logging = "OVERRIDE"
      log_configuration = {
        cloud_watch_log_group_name = "infisical-cluster-log-group"
      }
    }
  }

  fargate_capacity_providers = {
    FARGATE = {
      default_capacity_provider_strategy = {
        weight = 70
      }
    }
    FARGATE_SPOT = {
      default_capacity_provider_strategy = {
        weight = 30
      }
    }
  }
}

module "ecs_main_server" {
  source      = "terraform-aws-modules/ecs/aws//modules/service"
  cluster_arn = module.ecs_cluster.arn

  assign_public_ip = true
  name             = local.name

  desired_count = 4
  autoscaling_min_capacity = 4
  autoscaling_max_capacity = 30

  cpu    = 2048 
  memory = 4096 

  autoscaling_policies = {
    cpu = {
      policy_type = "TargetTrackingScaling"
      target_tracking_scaling_policy_configuration = {
        predefined_metric_specification = {
          predefined_metric_type = "ECSServiceAverageCPUUtilization"
        }

        target_value = 60
        scale_in_cooldown = 60
      }
    }

    memory = {
      policy_type = "TargetTrackingScaling"

      target_tracking_scaling_policy_configuration = {
        predefined_metric_specification = {
          predefined_metric_type = "ECSServiceAverageMemoryUtilization"
        }

        target_value = 60
        scale_in_cooldown = 60
      }
    }
  }

  container_definitions = {
    infisical-core-platform = {
      essential = true
      image     = "infisical/infisical:v0.62.4-postgres"
      health_check = {
        command = ["CMD-SHELL", "wget  --no-verbose --tries=1 --spider http://localhost:8080/api/status || exit 1"]
        interval = 5
        startPeriod = 10
      }
      port_mappings = [
        {
          name          = "infisical-standalone"
          containerPort = 8080
          hostPort      = 8080
          protocol      = "tcp"
        }
      ]

      secrets = concat([
        for index, arn in data.aws_ssm_parameters_by_path.infisical_server_secrets.arns : { 
          name = reverse(split("/", data.aws_ssm_parameters_by_path.infisical_server_secrets.names[index]))[0], 
          valueFrom = arn
        }
      ])

      environment = [
        {
          "name": "DB_ROOT_CERT", // THIS IS BASE64 ENCODED RDS CERT for US-EAST-1, UPDATE IF USING DIFFERENT REGION
          "value": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVCakNDQXU2Z0F3SUJBZ0lKQU1jMFp6YVNVSzUxTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUdQTVFzd0NRWUQKVlFRR0V3SlZVekVRTUE0R0ExVUVCd3dIVTJWaGRIUnNaVEVUTUJFR0ExVUVDQXdLVjJGemFHbHVaM1J2YmpFaQpNQ0FHQTFVRUNnd1pRVzFoZW05dUlGZGxZaUJUWlhKMmFXTmxjeXdnU1c1akxqRVRNQkVHQTFVRUN3d0tRVzFoCmVtOXVJRkpFVXpFZ01CNEdBMVVFQXd3WFFXMWhlbTl1SUZKRVV5QlNiMjkwSURJd01Ua2dRMEV3SGhjTk1Ua3cKT0RJeU1UY3dPRFV3V2hjTk1qUXdPREl5TVRjd09EVXdXakNCanpFTE1Ba0dBMVVFQmhNQ1ZWTXhFREFPQmdOVgpCQWNNQjFObFlYUjBiR1V4RXpBUkJnTlZCQWdNQ2xkaGMyaHBibWQwYjI0eElqQWdCZ05WQkFvTUdVRnRZWHB2CmJpQlhaV0lnVTJWeWRtbGpaWE1zSUVsdVl5NHhFekFSQmdOVkJBc01Da0Z0WVhwdmJpQlNSRk14SURBZUJnTlYKQkFNTUYwRnRZWHB2YmlCU1JGTWdVbTl2ZENBeU1ERTVJRU5CTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQwpBUThBTUlJQkNnS0NBUUVBclhuRi9FNi9RaCtrdTNoUVRTS1BNaFFRbENwb1d2bkl0aHpYNk1LM3A1YTBlWEtaCm9XSWpZY05ORzZVd0pqcDRmVVhsNmdscDUzSm9ibit0V05YODhkTkgybjhEVmJwcFN3U2NWRTJMcHVMKzk0dlkKMEVZRS9YeE43c3ZLZWE4WXZscnFrVUJLeXhMeFRqaCtVL0tyR09hSHh6OXYwbDZaTmxEYnVhWnczcUlXZEQvSQo2YU5iR2VSVVZ0cE02UCtiV0lveFZsL2NhUXlsUVM2Q0VZVWsrQ3BWeUpTa29wd0pselhUMDd0TW9ETDVXZ1g5Ck8wOEtWZ0ROejlxUC9JR3RBY1JkdVJjTmlvSDNFOXY5ODFRTzF6dC9HcGIyZjhOcUFqVVVDVVp6T25pajZteDkKTWNaKzljV1g4OENSelIwdlFPRFd1WnNjZ0kwOE52TTY5Rm4yU1FJREFRQUJvMk13WVRBT0JnTlZIUThCQWY4RQpCQU1DQVFZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVWMxOWcyTHpMQTVqMEt4YzBMalphCnBtRC92Qjh3SHdZRFZSMGpCQmd3Rm9BVWMxOWcyTHpMQTVqMEt4YzBMalphcG1EL3ZCOHdEUVlKS29aSWh2Y04KQVFFTEJRQURnZ0VCQUhBRzdXVG15anpQUklNODVyVmorZldIc0xJdnFwdzZET2JJak1Xb2twbGlDZU1JTlpGVgp5bmZnQktzZjFFeHdidkpOellGWFc2ZGlobmd1REc5Vk1QcGkydXAvY3RRVE44dG05bkRLT3kwOHVOWm9vZk1jCk5VWnhLQ0VrVktaditJTDRvSG9lYXl0OGVndHYzdWpKTTZWMTRBc3RNUTZTd3Z3dkE5M0VQL1VnMmU0V0FYSHUKY2JJMU5BYlVnVkRxcCtEUmRmdlprZ1lLcnlqVFdkLzArMWZTOFgxYkJaVld6bDdlaXJOVm5IYlNIMlpEcE51WQowU0JkOGRqNUY2bGQzdDU4eWRaYnJUSHplN0pKT2Q4aWp5U0FwNC9raXU5VWZaV3VUUEFCekRhL0RTZHo5RGsvCnpQVzRDWFh2aExtRTAyVEE5L0hlQ3czS0VISXdpY051RWZ3PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFQnpDQ0F1K2dBd0lCQWdJQ0pWVXdEUVlKS29aSWh2Y05BUUVMQlFBd2dZOHhDekFKQmdOVkJBWVRBbFZUCk1SQXdEZ1lEVlFRSERBZFRaV0YwZEd4bE1STXdFUVlEVlFRSURBcFhZWE5vYVc1bmRHOXVNU0l3SUFZRFZRUUsKREJsQmJXRjZiMjRnVjJWaUlGTmxjblpwWTJWekxDQkpibU11TVJNd0VRWURWUVFMREFwQmJXRjZiMjRnVWtSVApNU0F3SGdZRFZRUUREQmRCYldGNmIyNGdVa1JUSUZKdmIzUWdNakF4T1NCRFFUQWVGdzB4T1RBNU1Ua3hPREUyCk5UTmFGdzB5TkRBNE1qSXhOekE0TlRCYU1JR1VNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0F3S1YyRnoKYUdsdVozUnZiakVRTUE0R0ExVUVCd3dIVTJWaGRIUnNaVEVpTUNBR0ExVUVDZ3daUVcxaGVtOXVJRmRsWWlCVApaWEoyYVdObGN5d2dTVzVqTGpFVE1CRUdBMVVFQ3d3S1FXMWhlbTl1SUZKRVV6RWxNQ01HQTFVRUF3d2NRVzFoCmVtOXVJRkpFVXlCMWN5MWxZWE4wTFRFZ01qQXhPU0JEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVAKQURDQ0FRb0NnZ0VCQU0zaS9rMnU2Y3FiTWRjSVNHUnZoK20rTDB5YVNJb09YanRwTkVvSWZ0QWlwVFVZb01oTApJblhHbFFCVkE0c2hrZWt4cDFON0hYZTFZL2lNYVBFeWIzbisxNnBmM3ZkaktsN2thU2tJaGpkVXozb1ZVRVl0Cmk4Wi9YZUpKOUgyYUVHdWlaaDNrSGl4UWNaY3puOGNnM2RBOWFlZXlMU0VuVGtsL25wekxmLy82NjlBbW15aHMKWGNBbzU4eXZUMEQ0RTBEL0VFSGYyTjdIUlg3ai9UbHlXdncvMzlTVzB1c2lDckhQS0RMeEJ5TG9qeExkSHpzbwpRSXAvUzA0bStlV242cm1EK3VVaVJ0ZU4xaEk1bmNRaUEzd280RzM3bUhuVUVLbzZUdFRVaCtzZC9rdTZhOEhLCmdsTUJjZ3F1ZERJOTBzMU9wdUlBV211V3BZLy84eEVHMllFQ0F3RUFBYU5tTUdRd0RnWURWUjBQQVFIL0JBUUQKQWdFR01CSUdBMVVkRXdFQi93UUlNQVlCQWY4Q0FRQXdIUVlEVlIwT0JCWUVGUHFob1daY3JWWTltVTd0dWVtUgpSQm5RSWoxak1COEdBMVVkSXdRWU1CYUFGSE5mWU5pOHl3T1k5Q3NYTkM0MldxWmcvN3dmTUEwR0NTcUdTSWIzCkRRRUJDd1VBQTRJQkFRQjZ6T0xaK1lJTkVzNzJoZUhJV2xQWjhjNldZOE1EVStCZTV3MU0rQksya3BjVmhDVUsKUEpPNG5NWHBnYW1FWDhESWlhTzdlbXN1bndKek1TdmF2U1BSbnhYWFRLSWMwaS9nMUViaURqbllYOWQ4NURrQwpFMUxhQVVDbUNaQlZpOWZJZTBIMnI5d2hJaDR1TFdaQTQxb01uSngvTU9tbzNYeU1mUW9XY3FhU0ZsTXFmWk00CjByTm9CL3RkSExOdVY0ZUlkYXcybWxIeGRXRHRGNG9IK0hGbSsyY1ZCVVZDMWpYS3JGdi9ldVJWdHNUVCtBNmkKaDJYQkhLeFExWTRIZ0FuMGpBQ1AyUVNQRW11b1FFSWE1N2JFS0VjWnNCUjhTRFk2WmRUZDJITFJJQXBjQ09TRgpNUk04Q0tMZUY2NThJMFhnRjhENUVzWW9LUHNBKzc0WitqREgKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQotLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0KTUlJRC96Q0NBdWVnQXdJQkFnSVJBUFZTTWZGaXRtTTVQaG1iYU9Gb0dmVXdEUVlKS29aSWh2Y05BUUVMQlFBdwpnWmN4Q3pBSkJnTlZCQVlUQWxWVE1TSXdJQVlEVlFRS0RCbEJiV0Y2YjI0Z1YyVmlJRk5sY25acFkyVnpMQ0JKCmJtTXVNUk13RVFZRFZRUUxEQXBCYldGNmIyNGdVa1JUTVFzd0NRWURWUVFJREFKWFFURXdNQzRHQTFVRUF3d24KUVcxaGVtOXVJRkpFVXlCMWN5MWxZWE4wTFRFZ1VtOXZkQ0JEUVNCU1UwRXlNRFE0SUVjeE1SQXdEZ1lEVlFRSApEQWRUWldGMGRHeGxNQ0FYRFRJeE1EVXlOVEl5TXpRMU4xb1lEekl3TmpFd05USTFNak16TkRVM1dqQ0JsekVMCk1Ba0dBMVVFQmhNQ1ZWTXhJakFnQmdOVkJBb01HVUZ0WVhwdmJpQlhaV0lnVTJWeWRtbGpaWE1zSUVsdVl5NHgKRXpBUkJnTlZCQXNNQ2tGdFlYcHZiaUJTUkZNeEN6QUpCZ05WQkFnTUFsZEJNVEF3TGdZRFZRUUREQ2RCYldGNgpiMjRnVWtSVElIVnpMV1ZoYzNRdE1TQlNiMjkwSUVOQklGSlRRVEl3TkRnZ1J6RXhFREFPQmdOVkJBY01CMU5sCllYUjBiR1V3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRRHU5SDdUQmVHb0R6TXIKZHhONkg4Q09udEpYNElSNmRieWhuajVxTUQ0eGwvSVd2cDUwbHQwVnBtTWQrejJQTlp6eDhSYXplR0M1SW5pVgo1bnJMZzBBS1dSUTJBL2xHR1hiVXJHWENTZTA5YnJNUUN4V0JTSVllMVdaWjFpVTFJSi82QnA0RDJZRUhwWHJXCmJQa09xNXgzWVBjc29pdGdtMVhoOHlnejZ2YjdQc3ZKdlBidlJNbmtEZzVJcUVUaGFwUGptS2I4WkpXeUVGRUUKUVJya0NJUnVlQjFFcVF0SncwZnZQNFBLRGxDSkFLQkVzL3kwNDlGb09xWXBUM3BSeTBXS3FQaFd2ZStoU2NNZAo2b2JxOGt4VEZ5MUlIQUNqSGM1MW5yR0lJNUJ0NzYvTXBUV2huSklKckNucTEvVWMzUXM4SVZlYitzTGFGQzhLCkRJNjlTdzZiQWdNQkFBR2pRakJBTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRkU3UENvcHQKbHlPZ3RYWDBZMWxPYkJVeHVLYUNNQTRHQTFVZER3RUIvd1FFQXdJQmhqQU5CZ2txaGtpRzl3MEJBUXNGQUFPQwpBUUVBRmorYlg4Z0xtTU5lZnI1alJKZkhqckwzaXVaQ2pmN1lFWmduODlwUzR6ODQwOG1qajl6NlE1RDFIN3lTCmpORVRWVjhRYUppcDFxeWhoNWdSelJhQXJnR0FZdmkyL3IwelBzeStUZ2Y3djFLR0w1TGg4TlQ4aUNFR0dYd0YKZzNJcitObDNlKzlYVXAwZXl5ekJJakh0akxCbTZ5eThyR2s5cDZPdEZEUW5LRjVPeHdiQWdpcDQyQ0Q3NXIvcQpwNDIxbWFFRER2dlJGUjREKzk5Slp4Z0FZREJHcVJSY2VVb2UxNnFEemJNdmx6MEE5cGFDWkZjbHhlZnRBeHY2ClFsUjVySXRNei9YZHpwQkpVcFloZHpNMGdDekF6ZFF1Vk81dGpKeG1YaGtTTWNEUCs4UStVdjZGQTlrMlZwVVYKRS9PNWpncHFVSkoySGMvNXJzOVZrQVBYZUE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlGL2pDQ0ErYWdBd0lCQWdJUWFSSGFFcXFhY1hOMjBlOHpaSnRtRERBTkJna3Foa2lHOXcwQkFRd0ZBRENCCmx6RUxNQWtHQTFVRUJoTUNWVk14SWpBZ0JnTlZCQW9NR1VGdFlYcHZiaUJYWldJZ1UyVnlkbWxqWlhNc0lFbHUKWXk0eEV6QVJCZ05WQkFzTUNrRnRZWHB2YmlCU1JGTXhDekFKQmdOVkJBZ01BbGRCTVRBd0xnWURWUVFERENkQgpiV0Y2YjI0Z1VrUlRJSFZ6TFdWaGMzUXRNU0JTYjI5MElFTkJJRkpUUVRRd09UWWdSekV4RURBT0JnTlZCQWNNCkIxTmxZWFIwYkdVd0lCY05NakV3TlRJMU1qSXpPRE0xV2hnUE1qRXlNVEExTWpVeU16TTRNelZhTUlHWE1Rc3cKQ1FZRFZRUUdFd0pWVXpFaU1DQUdBMVVFQ2d3WlFXMWhlbTl1SUZkbFlpQlRaWEoyYVdObGN5d2dTVzVqTGpFVApNQkVHQTFVRUN3d0tRVzFoZW05dUlGSkVVekVMTUFrR0ExVUVDQXdDVjBFeE1EQXVCZ05WQkFNTUowRnRZWHB2CmJpQlNSRk1nZFhNdFpXRnpkQzB4SUZKdmIzUWdRMEVnVWxOQk5EQTVOaUJITVRFUU1BNEdBMVVFQnd3SFUyVmgKZEhSc1pUQ0NBaUl3RFFZSktvWklodmNOQVFFQkJRQURnZ0lQQURDQ0Fnb0NnZ0lCQUluZkJDYUh1dmo2UmI1YwpMNVdtbjFqdjJQSHRFR01IbSs3WjhkWW9zZHdvdUc4VkcyQStCQ1lDWmZpajlsSUdzenJUWGtZNE83dm5YZ3J1CkpVTmR4aDBRM004M3A0WCtiZytnT0RVczNqZitaM09lcTduVE9rLzJVWXZRTGN4UDRGRVhJTHhESW5iUUZjSXgKeWVuMUVTSGdnR3JqRW9kZ242bmJLUU5SZkloamhXK1RLWWFld2ZzVldIN0VGMnBmaitjamJKNm5qamdaMC9NOQpWWmlmSkZCZ2F0NlhVVE9mM2p3SHdrQ0JoN1Q2ckRwZ3kxOUE2MWxhSW1KQ1FoZFRuSEt2elRweGN4aUxSaDY5ClpPYnlwUjdXMDRPQVVtRlM4OFY3SW90bFBtQ0w4eGY3a3d4RytnUWZ2eDMxK0E5SURNc2lUcUoxQ2M0ZllFS2cKYkwrVm8rMklpNFcyZXNDVEdWWW1IbTczZHJ6bmZlS3dMK2ttSUMvQnErRHJaK3ZlVHFLRll3U2twSFJ5SkNFZQpVNFp5bTZQT3FRLzRMQlNLd0RVaFdMSklscTk5YmpLWCtoTlRKeWtCK0xiY3gwU2NPUDRJQVpRb3htRHhHV3hOClMrbFFqK0N4MnB3VTNTLzcrT3hsUm5kWkFYL0ZLZ2s3eFNNa2c4OEh5a1VaYVovb3pJaXFKcVNuR3BnWEN0RUQKb1E0T0p3NW96QXIrL3d1ZE9hd2FNd1VXUWw1YXNEOGZ1eS9obDVTMW52OVh4SWM4NDJRSk90SkZ4aHllTUlYdApMVkVDVncvZFBla2hNalMzWm8zd3dSZ1libktHN1lYWFQ1V014SkVuSHU4K2NZcE1pUkNsenEyQkVQNi9NdEkyCkFaUVFVRnUyeUZqUkdMMk9aQTZJWWp4blhZaVJBZ01CQUFHalFqQkFNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHcKSFFZRFZSME9CQllFRkFEQ2NRQ1BYMkhta3FRY211SGZpUTJqanFuck1BNEdBMVVkRHdFQi93UUVBd0lCaGpBTgpCZ2txaGtpRzl3MEJBUXdGQUFPQ0FnRUFTWGtHUTJlVW11ZElLUGVPSUY3UkJyeUNvUG1NT3NxUDArMXF4RjhsCnBHa3dtcmdOREdwbWQ5czBBcmZJVkJUYzFqbXBnQjNvaVJXOWM2bjJPbXdCS0w0VVB1UThPM0t3U1AwaUQyc1oKS01Yb01FeXBoQ0V6VzFJMkdSdllEdWdMM1o5TVdybkhrb2FvSDJsOFl5VFl2c3pUdmRneEJQcE0yeDRwU2twKwo3NmQ0L2VScEo1bVZ1UTkzbkMrWUcwd1hDeFNxNjNoWDRreVpnUHhnQ2RBQStxZ0ZmS0lHeU5xVUlxV2dleVRQCm41T2dLYWJvWWsyMTQxUmYyaEdNRDMvaHNHbTByckpoN2czQzBaaXJQd3MzZWVKZnVsdkFPSXkySVp6cUhVU1kKamtGenJhejZMRUgzSWxBclQzalVQdldLcXZoMmxKV25ucDU2YXF4QlI3cUhINXZvRDQ5VXBKV1kxSzBCakduUwpPSGN1cnBwMFl0L0JJczRWWmVXZENad0k3SmFTZURjUE1hTURCdk5EM0lhNUZnYTB0aGdZUVRHNmRFK041ZmdGCnoraFJhdWpYTzJuYjBMbWRkVnl2RThwcllsV1JNdVlGditDbzhoY01kSjBsRVpsZlZOdTBqYm05L0dtd0FaK2wKOXVtZVlPOXl6L3VDN2VkQzhYSkJnbE1BS1VtVks5d050T2NrVVdBY0NmblBXWUxiWWEvUHF0WEJZY3hyc281agppYVMvQTdpRVc1MXV0ZUhCR3JWaUN5MWFmR0craGlVV3dGbGVzbGkrUnE0ZE5zdFgzaDZoMmJhV0FCYUF4RVZKCnkxUm5UUVN6Nm1ST1QxVm1aU2dTVk8zN3JnSXlZMEhmMDg3Mm9nY1RTK0ZmdlhnQnhDeHNOV0ViaVEvWFh2YTQKMFdzPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlDcmpDQ0FqU2dBd0lCQWdJUkFQQWxFazhWSlBtRXpWUlJhV3ZUaDJBd0NnWUlLb1pJemowRUF3TXdnWll4CkN6QUpCZ05WQkFZVEFsVlRNU0l3SUFZRFZRUUtEQmxCYldGNmIyNGdWMlZpSUZObGNuWnBZMlZ6TENCSmJtTXUKTVJNd0VRWURWUVFMREFwQmJXRjZiMjRnVWtSVE1Rc3dDUVlEVlFRSURBSlhRVEV2TUMwR0ExVUVBd3dtUVcxaAplbTl1SUZKRVV5QjFjeTFsWVhOMExURWdVbTl2ZENCRFFTQkZRME16T0RRZ1J6RXhFREFPQmdOVkJBY01CMU5sCllYUjBiR1V3SUJjTk1qRXdOVEkxTWpJME1UVTFXaGdQTWpFeU1UQTFNalV5TXpReE5UVmFNSUdXTVFzd0NRWUQKVlFRR0V3SlZVekVpTUNBR0ExVUVDZ3daUVcxaGVtOXVJRmRsWWlCVFpYSjJhV05sY3l3Z1NXNWpMakVUTUJFRwpBMVVFQ3d3S1FXMWhlbTl1SUZKRVV6RUxNQWtHQTFVRUNBd0NWMEV4THpBdEJnTlZCQU1NSmtGdFlYcHZiaUJTClJGTWdkWE10WldGemRDMHhJRkp2YjNRZ1EwRWdSVU5ETXpnMElFY3hNUkF3RGdZRFZRUUhEQWRUWldGMGRHeGwKTUhZd0VBWUhLb1pJemowQ0FRWUZLNEVFQUNJRFlnQUV4NXhqcnVwOElJNEhPSncxNU5UblMzSDV5TXJRR2xiagpFREE1TU1HbkU5RG1IcDVkQUNJeG1QWFBNZS85OW5PN3dOZGw3RzcxT1lQQ2dFdldtMEZoZHZWVWVUYjNMVm5WCkJuYVh0MzJFazcvb3hHazFUK0RmMDNDK1cwdm11Sit3bzBJd1FEQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEcKQTFVZERnUVdCQlRHWG1xQldOLzF0a1NlYTRwTncwb0hyamsyVURBT0JnTlZIUThCQWY4RUJBTUNBWVl3Q2dZSQpLb1pJemowRUF3TURhQUF3WlFJeEFJcXFaV0NTcklrWjd6c3YvRnlndEF1c1c2eXZsTDkzNVlBV1lQVlhVMzBtCmprTUZMTSsvUko5R012bk84akhmQ2dJd0Ird2hsa2NJdHpFOUNSUTZDc01vL2Q1Y0VIRFV1L1FXNmpTSWg5QlIKT0doOXBUWVBWa1ViQmlLUEE3bFZWaHJlCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
        }
      ]

      readonly_root_filesystem = false

      memory_reservation = 100
    }
  }

  load_balancer = {
    service = {
      target_group_arn = module.alb.target_groups["target_ecs"].arn
      container_name   = "infisical-core-platform"
      container_port   = 8080
    }
  }

  subnet_ids         = module.vpc.public_subnets
  security_group_ids = [aws_security_group.core_server_ecs.id]
}



